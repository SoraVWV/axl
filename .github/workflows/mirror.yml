name: Mirror to GitLab

on:
  push:
    branches:
      - '**'
    tags:
      - '**'

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check GitLab mirroring
        id: check_commit
        run: |
          if git log -1 --pretty=format:'%s' | grep -q 'Mirrored from GitLab'; then
            echo "::set-output name=is_mirrored::true"
          else
            echo "::set-output name=is_mirrored::false"
          fi

      - name: Remove remote
        if: steps.check_commit.outputs.is_mirrored == 'false'
        run: |
          git remote remove github || true

      - name: Mirror to GitLab
        if: steps.check_commit.outputs.is_mirrored == 'false'
        run: |
          git remote add gitlab https://axl:$GITLAB_TOKEN@gitlab.axolotl-lang.ru/lite/compiler.git
          git push --mirror gitlab

          echo "Mirrored from GitHub" | git commit --allow-empty -F -
          git push origin
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}